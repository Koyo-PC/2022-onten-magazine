---
title: VRChatでめちゃくちゃリアルな星空を作った話
author: ZOI
---

またまたこんにちは、ZOIです。
この章では、VRで見れる、めちゃくちゃリアルな星空を作ってみたので、その話をしていきます。

## 1. 星の再現

さて、星空を作るということで、まず星が必要です。
星空の画像を撮ってきて貼ればいいんですが、それだと面白くないですよね〜。
というわけでせっかくなので、現実の星のデータを使って星を表示してみようと思います!
星のデータをWikipediaかどこかで一つずつ調べていくと死んでしまうので、ESA(ヨーロッパ宇宙機関)がまとめてくれた便利なデータを使います。
今回使うのは`Hipparcos`、`Gaia`という2つの衛星で観測されたものにします。
それぞれHipparcos星表、Gaia星表と呼ぶことにすると、Hipparcos星表は主に明るい星(12等星以上)、Gaia星表は暗い星(20等星以上)の情報を含んでいます。
このデータを使ってどのように星を表示するか考えましょう。
もちろん星を一つ一つ3Dデータとして表示するのでもいいのですが、さっき紹介したHipparcos星表は約12万、Gaia星表は約18億の星のデータがあります。
こんなものを3Dデータとして使ってしまうと、たとえ星を1ポリゴンで表せたとしても、18億ポリゴンになってしまいます。
これをOBJ形式で表した場合、少なめに(1ポリゴン=50バイトで)見積もっても90GiBになります。
現実的じゃないです。
そこで、8Kサイズのテクスチャに星空を書き込んでおいて、それを球に貼り付けて表示することにしましょう。

### a. データの取得

さて、今からテクスチャに書き込んでいくわけですが、画像出力する時にはHipparcos星表、Gaia星表の全てのデータを持っておく必要があります。
というわけでダウンロードです。
どう考えてもGaia星表のダウンロードには時間がかかるので、先に始めましょう。

まず、Gaia星表はいくつかバーションがあるのですが、今回は最新(2022/3/12時点)のEarly Data Release3を使ってみます。
<http://cdn.gea.esac.esa.int/Gaia/gedr3/gaia_source/>からダウンロードできるのですが、`3386`個の圧縮ファイルに分けて公開されています。
これを手作業でダウンロードするのは大変なので、さっさとスクリプトを書いてパソコンに無休労働させましょう。
Webページにリンクが並んでいるので、今回はLinuxのwgetの`-r`オプションを使ってみます。
もちろん、下の方で公開されている`_MD5SUM.txt`あたりからファイル名を抽出(簡単です)すれば他にもいろいろなやり方ができるので、それでも何の問題もありません。
僕が持っているデスクトップはWindowsなので、WSLで実行することにして、こんな感じのスクリプトを書いてみました。

`download.sh`

```bash
#!/bin/sh
cd "/mnt/f/Gaia EDR3/data/"
wget -r --no-parent --continue http://cdn.gea.esac.int/Gaia/gedr3/gaia_source/
read -p "Press [Enter] key to resume."
```

これを`$ ./download.sh`で実行すればダウンロード完了...なのですが、なんせサイズがめちゃくちゃでかいので数日かかります。
パソコンの容量も足りなくなるとおもうので、家に転がっている1, 2TBくらいのHDDを持ってきましょう。

参考になるかわかりませんが、僕の場合は〇〇GBあり、ダウンロードには〇〇時間かかりました。
`wget`でのダウンロードでは早くても700KB/sしか出てなかったので、設定がおかしかったのかもしれません。
少なくとも`aria2`など早いダウンローダーを使うべきですね。
(`-r`に相当するものはなさそうですが)

次はHipparcos星表のダウンロードです。
Hipparcos星表のデータは`FTP`という仕組みを使ってダウンロードするようになっています。
(FTPはHTTPのファイル特化バージョンみたいなものです。)
とりあえずChromeか何かで<ftp://dbc.nao.ac.jp/DBC/NASAADC/catalogs/1/1239/>を開きましょう。
ユーザー名やパスワードを聞かれるとおもうのですが、`匿名でログインする`を選択して進みます。
するとNASAのサーバー上のフォルダを開いたみたいな感じになっているとおもうので、その中にある`hip_main.dat.gz`を好きな場所(Gaiaの近くでいいと思います)にダウンロードしてきます。
サイズは約231MBです。
Gaiaと比べると小さく思えますが、一文字=1byteなので2億3千万文字で十分多いです。
(ちなみに「転生したらスライムだった件」は全部で200万文字程度です。)

...というわけで、星空の再現に必要なデータは全て揃いました!

### b. データの整理

さてデータをダウンロードしたわけですが、この中にはめちゃくちゃいろんなデータが含まれています。
今回は星を描画するだけなので、測定誤差とか明るさの変わりかたとかいう情報は必要ないです。
後で描画するときにデータを読み込むのですが、その時のファイルサイズはできるだけ小さい方が早くなります。
というわけで、データの必要な部分だけを別のファイルにコピーしていきましょう。

ダウンロードしたデータを見てみると、ファイル名が`.gz`で終わっていると思います。
`.gz`なんて知らないぞ? という方も多いと思いますが、圧縮ファイルの一種です。
zipファイルみたいなものです。
ここで問題なのは、圧縮されたままでは中のデータを参照できないこと、そして解凍したらさらに容量を食うことです。
なので、1ファイルずつの処理になりそうです。

処理を書く言語は何でもいいんですが、今回はC#を使います。

詳しくはGitHubのレポジトリ(<https://github.com/ZOI_dayo/>)を見てほしいのですが、流れとしては以下のような感じですね。

1. Gaiaデータ保存ディレクトリ内の全ての`.gz`ファイルに対して`2.`~`4.`を繰り返す
2. `.gz`ファイルを`byte[]`として読み込み、解凍して`string`に戻す
(解凍には`GZipStream`を利用)
3. `2.`でできたcsv形式のstringを`StarData[]`(自作構造体)に変換する
(`CsvHelper`のマッピング機能を利用)
4. `StarData[]`から必要な情報のみを抜き取り、場合によっては変換して別のファイルにCSV形式で書き込む
(ただしHipparcosに含まれているデータは除外)
5. Hipparcosに対しても繰り返す

データには本当にいろいろなデータが含まれているのですが、今回は「赤経」「赤緯」「等級」「色指数」というデータだけを使うことにします。

#### 用語解説

赤経 / 赤緯
: 北極星のあたりを天の北極として天球を考えた時の緯度 / 経度。
  天球上での星の位置を表します。

等級
: よく1等星とか2等星とか言ってるやつ。
  1等級上がると $\sqrt[5]{100}\fallingdotseq2.512$倍の明るさになる。
  マイナスや小数のときもあります。

色指数
: 星の色を表す値。
  今回はB-V色指数を基準にすることにしました。
  青の光を通すBバンドフィルタを通った光の強さから、緑〜黄の光を通すVバンドフィルタを通った光の強さを引いたものです。
  Gaia星表は独自のフィルタ(<https://www.cosmos.esa.int/web/gaia/edr3-passbands>)で計測しているので、ESAのページ(<https://gea.esac.esa.int/archive/documentation/GDR2/Data_processing/chap_cu5pho/sec_cu5pho_calibr/ssec_cu5pho_PhotTransf.html#Ch5.F15.g3>)にある式が使えそうです。
  しかし、$G - V$を$B - V$にする関数が欲しいので、これの逆関数ですね。
  かなりアバウトに計算した結果がこんな感じ(4)です。
  まあ元々ESAの式に誤差があるので、気にしないことにしましょう。
  逆関数を計算してくれるサイト(<https://ja.numberempire.com/inversefunctioncalculator.php>)があるので参考にさせてもらいました。

  $$
  \begin{aligned}
  G - V &= -0.02907 - 0.02385 \times (B - V) - 0.2297 \times (B - V)^2 - 0.001768 \times (B - V)^3 \\
  &\fallingdotseq -0.029 - 0.024 \times (B - V) - 0.23 \times (B - V)^2 \\
  \therefore B - V &\fallingdotseq \left\{
    \begin{array}{ll}
      {{\sqrt{2}\,\sqrt{-115000\,(G-V)-3263}-12}\over{230}}&(G-V \leq -\frac{3263}{115000}) \\
      -\frac{12}{230}&(G-V > -\frac{3263}{115000})
    \end{array}
  \right.\\
  &\fallingdotseq \left\{
    \begin{array}{ll}
      {{8\sqrt{-36\,(G-V)-1}-1}\over{23}}&(G-V \leq -\frac{1}{36}) \\
      -\frac{1}{23}&(G-V > -\frac{1}{36})
    \end{array}
  \right.
  \end{aligned}
  $$
